name: Mobile E2E Tests
permissions:
  contents: read

# This workflow is for manual runs only.
# PR runs are handled by pr.yml to coordinate with the translations job.
on:
  workflow_dispatch:

jobs:
  ios-e2e:
    name: iOS E2E Tests
    runs-on: macos-14
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build mobile app
        run: yarn build:mobile

      - name: Sync Capacitor
        run: npx cap sync ios

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.4.app

      - name: Build iOS app for simulator
        run: |
          xcodebuild -workspace ios/App/App.xcworkspace \
            -scheme App \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.5' \
            -configuration Debug \
            -derivedDataPath ios/App/build \
            build

      - name: Boot iOS Simulator
        run: |
          xcrun simctl boot "iPhone 15" || true
          xcrun simctl list devices

      - name: Install Appium
        run: |
          npm install -g appium
          appium driver install xcuitest

      - name: Start Appium server
        run: |
          appium --relaxed-security &
          sleep 10

      - name: Run iOS E2E tests
        run: yarn test:e2e:ios
        env:
          APPIUM_APP_PATH: ${{ github.workspace }}/ios/App/build/Build/Products/Debug-iphonesimulator/App.app

      - name: Upload test screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ios-e2e-screenshots
          path: mobile-e2e/screenshots/
          retention-days: 7

      - name: Upload Appium logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ios-appium-logs
          path: mobile-e2e/logs/
          retention-days: 7

  android-e2e:
    name: Android E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'yarn'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build mobile app
        run: yarn build:mobile

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Build Android APK
        run: |
          cd android
          ./gradlew assembleDebug
          cd ..

      - name: Install Appium
        run: |
          npm install -g appium
          appium driver install uiautomator2 || echo "Driver already installed"

      - name: Run Android E2E tests
        uses: reactivecircus/android-emulator-runner@v2
        timeout-minutes: 30
        with:
          api-level: 31
          target: default
          arch: x86_64
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -no-snapshot-load
          disable-animations: true
          script: |
            appium --relaxed-security &
            sleep 10
            yarn test:e2e:android

      - name: Upload test screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: android-e2e-screenshots
          path: mobile-e2e/screenshots/
          retention-days: 7

      - name: Upload Appium logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: android-appium-logs
          path: mobile-e2e/logs/
          retention-days: 7
