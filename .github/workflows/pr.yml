name: PR Tests

on:
  pull_request:
    branches:
      - main
      - dev
      - next
      - 'mw-**'
      - 'feat/**'

permissions:
  contents: read

jobs:
  translations:
    name: Update Translation Files
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Check Out Code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}

      - name: Use Node 22
        uses: actions/setup-node@v3
        with:
          node-version: 22

      - name: Run Install
        uses: borales/actions-yarn@v4
        with:
          cmd: install

      - name: Generate Translation Files
        uses: borales/actions-yarn@v4
        with:
          cmd: createTranslationFile

      - name: Check for changes
        id: git-check
        run: |
          git diff --quiet public/_locales/ || echo "changes=true" >> $GITHUB_OUTPUT

      # Only commit/push for non-fork PRs (forks can't push back)
      - name: Commit and push translation updates
        id: commit
        if: steps.git-check.outputs.changes == 'true' && github.event.pull_request.head.repo.full_name == github.repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add public/_locales/
          git commit -m "chore: update translation files"
          git push
          echo "committed=true" >> $GITHUB_OUTPUT

  ci:
    name: Test
    needs: translations
    runs-on: ubuntu-latest
    steps:
      - name: Check Out Code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      - name: Use Node 22
        uses: actions/setup-node@v3
        with:
          node-version: 22

      - name: Run Install
        uses: borales/actions-yarn@v4
        with:
          cmd: install

      - name: Run ESLint
        uses: borales/actions-yarn@v4
        with:
          cmd: lint

      - name: Run TypeScript Check
        uses: borales/actions-yarn@v4
        with:
          cmd: ts

      - name: Run Unit Tests
        uses: borales/actions-yarn@v4
        with:
          cmd: test

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Build chrome
        uses: borales/actions-yarn@v4
        with:
          cmd: build:chrome

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Run Playwright E2E
        run: xvfb-run -a yarn test:e2e

  coverage:
    name: Coverage Check (80% minimum)
    needs: translations
    runs-on: ubuntu-latest
    steps:
      - name: Check Out Code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      - name: Use Node 22
        uses: actions/setup-node@v3
        with:
          node-version: 22

      - name: Run Install
        uses: borales/actions-yarn@v4
        with:
          cmd: install

      - name: Run Coverage Check
        uses: borales/actions-yarn@v4
        with:
          cmd: test:coverage

  i18n-check:
    name: Check for non-i18n'd strings
    needs: translations
    runs-on: ubuntu-latest
    steps:
      - name: Check Out Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Check i18n compliance
        run: yarn lint:i18n

  ios-e2e:
    name: iOS E2E Tests
    needs: translations
    runs-on: macos-14
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build mobile app
        run: yarn build:mobile

      - name: Sync Capacitor
        run: npx cap sync ios

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.4.app

      - name: Build iOS app for simulator
        run: |
          xcodebuild -workspace ios/App/App.xcworkspace \
            -scheme App \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.5' \
            -configuration Debug \
            -derivedDataPath ios/App/build \
            build

      - name: Boot iOS Simulator
        run: |
          xcrun simctl boot "iPhone 15" || true
          xcrun simctl list devices

      - name: Install Appium
        run: |
          npm install -g appium
          appium driver install xcuitest

      - name: Start Appium server
        run: |
          appium --relaxed-security &
          sleep 10

      - name: Run iOS E2E tests
        run: yarn test:e2e:ios
        env:
          APPIUM_APP_PATH: ${{ github.workspace }}/ios/App/build/Build/Products/Debug-iphonesimulator/App.app

      - name: Upload test screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ios-e2e-screenshots
          path: mobile-e2e/screenshots/
          retention-days: 7

      - name: Upload Appium logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ios-appium-logs
          path: mobile-e2e/logs/
          retention-days: 7

  android-e2e:
    name: Android E2E Tests
    needs: translations
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'yarn'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build mobile app
        run: yarn build:mobile

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Build Android APK
        run: |
          cd android
          ./gradlew assembleDebug
          cd ..

      - name: Install Appium
        run: |
          npm install -g appium
          appium driver install uiautomator2

      - name: AVD cache
        uses: actions/cache@v4
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-api-34-${{ runner.os }}

      - name: Create AVD and generate snapshot
        if: steps.avd-cache.outputs.cache-hit != 'true'
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          target: google_apis
          arch: x86_64
          profile: pixel_6
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          disable-animations: true
          script: echo "Generated AVD snapshot for caching."

      - name: Run Android E2E tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          target: google_apis
          arch: x86_64
          profile: pixel_6
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          disable-animations: true
          script: |
            appium --relaxed-security &
            sleep 10
            yarn test:e2e:android

      - name: Upload test screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: android-e2e-screenshots
          path: mobile-e2e/screenshots/
          retention-days: 7

      - name: Upload Appium logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: android-appium-logs
          path: mobile-e2e/logs/
          retention-days: 7
