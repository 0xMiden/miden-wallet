import React, { useCallback, useMemo, useState } from 'react';

import classNames from 'clsx';
import { shuffle } from 'lodash';
import { useTranslation } from 'react-i18next';

import { Button } from 'components/Button';
import { Chip } from 'components/Chip';
import { Toggle } from 'components/Toggle';
import { hapticLight } from 'lib/mobile/haptics';
import { isDesktop, isMobile } from 'lib/platform';

export interface VerifySeedPhraseScreenProps extends React.ButtonHTMLAttributes<HTMLDivElement> {
  seedPhrase: string[];
  useBiometric?: boolean;
  onBiometricChange?: (value: boolean) => void;
  onSubmit?: () => void;
}

export const VerifySeedPhraseScreen: React.FC<VerifySeedPhraseScreenProps> = ({
  seedPhrase,
  useBiometric = true,
  onBiometricChange,
  className,
  onSubmit,
  ...props
}) => {
  const showBiometricToggle = isMobile() || isDesktop();
  const { t } = useTranslation();
  const shuffledWords = useMemo(() => shuffle(seedPhrase), [seedPhrase]);
  const [firstSelectedWordIndex, setFirstSelectedWord] = useState<number | null>(null);
  const [secondSelectedWordIndex, setSecondSelectedWord] = useState<number | null>(null);

  const onSelectWord = useCallback(
    (index: number) => {
      hapticLight();
      // we select first word if index was not selected before
      if (firstSelectedWordIndex === null && index !== secondSelectedWordIndex) {
        setFirstSelectedWord(index);
        return;
      }
      // if word is already selected, we unselect it
      if (index === firstSelectedWordIndex) {
        setFirstSelectedWord(null);
        return;
      }
      // if first word is selected, we select second word
      if (index === secondSelectedWordIndex) {
        setSecondSelectedWord(null);
        return;
      }
      setSecondSelectedWord(index);
    },
    [firstSelectedWordIndex, secondSelectedWordIndex]
  );
  console.log({ firstSelectedWordIndex, secondSelectedWordIndex });
  console.log(seedPhrase);
  const isCorrectWordSelected = useMemo(() => {
    if (firstSelectedWordIndex === null || secondSelectedWordIndex === null) {
      return false;
    }
    return (
      shuffledWords[firstSelectedWordIndex] === seedPhrase[0] &&
      shuffledWords[secondSelectedWordIndex] === seedPhrase[11]
    );
  }, [seedPhrase, firstSelectedWordIndex, secondSelectedWordIndex, shuffledWords]);

  return (
    <div
      className={classNames('flex-1', 'flex flex-col', 'bg-white gap-8 p-6', className)}
      data-testid="verify-seed-phrase"
      {...props}
    >
      <div className="flex flex-col items-center">
        <header className="text-2xl font-semibold">{t('verifySeedPhrase')}</header>
        <p className="text-sm font-normal mt-2 w-[500px] text-center">{t('verifyMessagePrefix')}</p>
      </div>

      <article className="grid grid-cols-3 gap-4 w-[80%] self-center">
        {shuffledWords.map((word, index) => (
          <div className="relative">
            {(!!firstSelectedWordIndex || firstSelectedWordIndex === 0) && index === firstSelectedWordIndex && (
              <div className="absolute -top-3 left-2 -translate-x-2 bg-primary-orange text-white px-2 py-0.5 rounded-full text-xs whitespace-nowrap">
                {t('first')}
              </div>
            )}
            {(!!secondSelectedWordIndex || secondSelectedWordIndex === 0) && index === secondSelectedWordIndex && (
              <div className="absolute -top-3 left-2 -translate-x-2 bg-primary-orange text-white px-2 py-0.5 rounded-full text-xs whitespace-nowrap">
                {t('last')}
              </div>
            )}
            <button onClick={() => onSelectWord(index)} className="w-full">
              <Chip
                className="cursor-pointer"
                selected={firstSelectedWordIndex === index || secondSelectedWordIndex === index}
                label={word}
              />
            </button>
          </div>
        ))}
      </article>

      <div className="flex-1" />

      <div className="w-[360px] flex flex-col gap-4 self-center pb-4">
        {showBiometricToggle && (
          <>
            <div className="flex flex-col gap-1 px-2">
              <h3 className="text-lg font-semibold">{t('unlockWallet')}</h3>
              <p className="text-sm text-grey-600">{t('unlockWalletDescription')}</p>
            </div>
            <div className="flex items-center justify-between gap-3 px-2">
              <p className="text-sm text-grey-600 flex-1">{t('passwordsCanBeInsecure')}</p>
              <Toggle value={useBiometric} onChangeValue={onBiometricChange} />
            </div>
          </>
        )}
        <Button disabled={!isCorrectWordSelected} title={t('continue')} onClick={onSubmit} />
      </div>
    </div>
  );
};
